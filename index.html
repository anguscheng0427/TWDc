<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TWDåŒ¯ç‡æ›ç®— | TWD Converter</title>
    <meta name="description" content="å°å¹£åŒ¯ç‡æ›ç®—å·¥å…·ï¼Œæ”¯æ´å¤šç¨®è²¨å¹£ï¼Œé›¢ç·šå¯ç”¨ï¼Œç°¡å–®æ˜“ç”¨çš„åŒ¯ç‡æ›ç®—å™¨ã€‚ Developed by Angus.">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <link rel="icon" href="./assets/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="./assets/icon_192.png">
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            /* å›æ­¸ V3 çš„ç¶“å…¸è—è‰²æ¼¸å±¤èƒŒæ™¯ */
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            background-attachment: fixed;
            height: 100vh; /* ä½¿ç”¨ 100vh ç¢ºä¿æ»¿ç‰ˆ */
            height: 100dvh; /* é‡å°è¡Œå‹•ç€è¦½å™¨å„ªåŒ– */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* ä¸ŠåŠéƒ¨é¡¯ç¤ºå€çš„æ¯›ç»ç’ƒæ•ˆæœ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* æŒ‰éˆ•é»æ“Šæ•ˆæœ */
        .active-scale:active {
            transform: scale(0.95);
        }

        /* éµç›¤æŒ‰éˆ•æ¨£å¼ - å¼·åˆ¶é«˜åº¦çµ±ä¸€ */
        .key-btn {
            height: 3.5rem; /* å›ºå®šé«˜åº¦ */
            border-radius: 0.75rem;
            font-size: 1.5rem;
            font-weight: 500;
            color: #1f2937; /* Gray-800 */
            background-color: #f3f4f6; /* Gray-100 */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
        }
        .key-btn:active {
            background-color: #e5e7eb; /* Gray-200 */
            transform: translateY(1px);
            box-shadow: none;
        }
        
        /* é‡å°å°è¢å¹•æ‰‹æ©Ÿå¾®èª¿ */
        @media (max-height: 680px) {
            .key-btn { height: 3rem; font-size: 1.25rem; }
            .display-text { font-size: 2.5rem; }
        }

        /* PWA å®‰è£æç¤ºå‹•ç•« */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .install-banner {
            animation: slideUp 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CURRENCIES = [
            { code: 'JPY', name: 'æ—¥å¹£', flag: 'ğŸ‡¯ğŸ‡µ' },
            { code: 'USD', name: 'ç¾é‡‘', flag: 'ğŸ‡ºğŸ‡¸' },
            { code: 'CNY', name: 'äººæ°‘å¹£', flag: 'ğŸ‡¨ğŸ‡³' },
            { code: 'KRW', name: 'éŸ“å…ƒ', flag: 'ğŸ‡°ğŸ‡·' },
            { code: 'EUR', name: 'æ­å…ƒ', flag: 'ğŸ‡ªğŸ‡º' },
            { code: 'THB', name: 'æ³°éŠ–', flag: 'ğŸ‡¹ğŸ‡­' },
            { code: 'HKD', name: 'æ¸¯å¹£', flag: 'ğŸ‡­ğŸ‡°' },
            { code: 'GBP', name: 'è‹±éŠ', flag: 'ğŸ‡¬ğŸ‡§' },
            { code: 'AUD', name: 'æ¾³å¹£', flag: 'ğŸ‡¦ğŸ‡º' },
            { code: 'SGD', name: 'æ–°å¹£', flag: 'ğŸ‡¸ğŸ‡¬' },
            { code: 'VND', name: 'è¶Šå—ç›¾', flag: 'ğŸ‡»ğŸ‡³' }
        ];

        function App() {
            // --- 1. ç‹€æ…‹ State (å·²ä¿®å¾©ï¼šè®€å– localStorage) ---
            const [amount, setAmount] = useState('');
            
            // ä¿®å¾©ï¼šå„ªå…ˆå¾ localStorage è®€å–ä¸Šæ¬¡é¸çš„å¹£åˆ¥
            const [targetCurrency, setTargetCurrency] = useState(() => {
                return localStorage.getItem('user_target_currency') || 'JPY';
            });
            
            const [rates, setRates] = useState(null);
            const [isOffline, setIsOffline] = useState(!navigator.onLine);
            
            // ä¿®å¾©ï¼šå„ªå…ˆå¾ localStorage è®€å–ä¸Šæ¬¡çš„äº¤æ›æ¨¡å¼
            const [isSwapMode, setIsSwapMode] = useState(() => {
                return localStorage.getItem('user_swap_mode') === 'true';
            });

            // PWA å®‰è£æç¤ºç‹€æ…‹
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isIOS, setIsIOS] = useState(false);

            // --- 2. PWA å®‰è£é‚è¼¯ ---
            useEffect(() => {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                if (isStandalone) return; 

                const userAgent = window.navigator.userAgent.toLowerCase();
                const ios = /iphone|ipad|ipod/.test(userAgent);
                setIsIOS(ios);

                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    if (!localStorage.getItem('install_prompt_closed')) {
                        setTimeout(() => setShowInstallPrompt(true), 2000);
                    }
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                if (ios && !localStorage.getItem('install_prompt_closed')) {
                    setTimeout(() => setShowInstallPrompt(true), 3000);
                }

                return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
            }, []);

            const handleInstallClick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') setShowInstallPrompt(false);
                    setDeferredPrompt(null);
                }
            };

            const closeInstallPrompt = () => {
                setShowInstallPrompt(false);
                localStorage.setItem('install_prompt_closed', 'true');
            };

            // --- 3. è¨˜æ†¶åŠŸèƒ½ Effect (å·²ä¿®å¾©ï¼šå¯«å…¥ localStorage) ---
            useEffect(() => {
                localStorage.setItem('user_target_currency', targetCurrency);
            }, [targetCurrency]);

            useEffect(() => {
                localStorage.setItem('user_swap_mode', isSwapMode);
            }, [isSwapMode]);

            // --- 4. åŒ¯ç‡æŠ“å– ---
            useEffect(() => {
                const fetchRates = async () => {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                        if (!response.ok) throw new Error('Network error');
                        const data = await response.json();
                        setRates(data.rates);
                        localStorage.setItem('twd_rates', JSON.stringify(data.rates));
                    } catch (error) {
                        const cachedRates = localStorage.getItem('twd_rates');
                        if (cachedRates) setRates(JSON.parse(cachedRates));
                    }
                };
                fetchRates();
                window.addEventListener('online', () => setIsOffline(false));
                window.addEventListener('offline', () => setIsOffline(true));
            }, []);

            // --- 5. è¨ˆç®—é‚è¼¯ ---
            const result = useMemo(() => {
                if (!rates || !amount) return 0;
                const rate = rates[targetCurrency];
                if (!rate) return 0;
                return isSwapMode ? parseFloat(amount) * rate : parseFloat(amount) / rate;
            }, [amount, targetCurrency, rates, isSwapMode]);

            const rateString = useMemo(() => {
                if (!rates || !rates[targetCurrency]) return 'è¼‰å…¥ä¸­...';
                const rate = rates[targetCurrency];
                return isSwapMode 
                    ? `1 TWD â‰ˆ ${rate.toFixed(4)} ${targetCurrency}`
                    : `1 ${targetCurrency} â‰ˆ ${(1/rate).toFixed(4)} TWD`;
            }, [rates, targetCurrency, isSwapMode]);

            const handleNumClick = (num) => {
                if (num === '.' && amount.includes('.')) return;
                if (amount.replace('.', '').length >= 10) return;
                setAmount(prev => prev + num);
            };

            const handleBackspace = () => setAmount(prev => prev.slice(0, -1));
            const handleClear = () => setAmount('');
            const toggleSwap = () => setIsSwapMode(!isSwapMode);

            const formatCurrency = (val) => {
                if (!val && val !== 0) return '';
                return new Intl.NumberFormat('zh-TW', {
                    style: 'decimal',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }).format(val);
            };

            // å‹•æ…‹å­—é«”å¤§å°
            const getDynamicFontSize = (valStr, isMainInput) => {
                const len = valStr ? valStr.length : 0;
                if (isMainInput) {
                    if (len > 10) return 'text-3xl';
                    if (len > 7) return 'text-4xl';
                    return 'text-5xl';
                } else {
                    if (len > 12) return 'text-2xl';
                    if (len > 9) return 'text-3xl';
                    return 'text-4xl';
                }
            };

            const currentCurrObj = CURRENCIES.find(c => c.code === targetCurrency) || CURRENCIES[0];
            const displayAmount = amount ? formatCurrency(amount) : '0';
            const displayResult = amount ? formatCurrency(result) : '0';

            return (
                <div className="h-full flex flex-col max-w-md mx-auto relative">
                    
                    {/* ä¸ŠåŠéƒ¨ï¼šè—è‰²æ¼¸å±¤èƒŒæ™¯å€ (é¡¯ç¤ºå…§å®¹) */}
                    <div className="flex-1 flex flex-col p-4 relative z-10 text-white min-h-[40%]">
                        
                        {/* æ¨™é¡Œ */}
                        <div className="flex justify-between items-center mb-4 opacity-90 px-1">
                            <div className="font-bold tracking-wide flex items-center gap-2">
                                <i className="fa-solid fa-circle-dollar-to-slot"></i> TWDåŒ¯ç‡æ›ç®—
                            </div>
                            <div className="text-xs bg-white/20 px-2 py-1 rounded-full backdrop-blur-sm">
                                {isOffline ? <span className="text-yellow-300"><i className="fa-solid fa-bolt"></i> é›¢ç·š</span> : 'Online'}
                            </div>
                        </div>

                        {/* æ ¸å¿ƒé¡¯ç¤ºå¡ç‰‡ */}
                        <div className="glass-panel rounded-3xl p-5 relative flex flex-col justify-center flex-1 shadow-lg">
                            
                            {/* äº¤æ›æŒ‰éˆ• */}
                            <button 
                                onClick={toggleSwap}
                                className="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-blue-500 shadow-xl border-2 border-white/30 text-white flex items-center justify-center active:scale-95 transition-all z-20 hover:bg-blue-600"
                            >
                                <i className="fa-solid fa-arrow-right-arrow-left rotate-90 text-lg"></i>
                            </button>

                            {/* è¼¸å…¥ (ä¸Š) */}
                            <div className="flex flex-col mb-4 border-b border-white/10 pb-2 pr-14">
                                <div className="text-blue-100/80 text-xs mb-1 font-medium tracking-wider">
                                    {isSwapMode ? 'ğŸ‡¹ğŸ‡¼ å°å¹£ (TWD)' : `${currentCurrObj.flag} ${currentCurrObj.name} (${currentCurrObj.code})`}
                                </div>
                                <div className={`font-bold flex items-center tracking-tight transition-all h-14 ${getDynamicFontSize(displayAmount, true)}`}>
                                    {amount ? displayAmount : <span className="opacity-20">0</span>}
                                </div>
                            </div>

                            {/* çµæœ (ä¸‹) */}
                            <div className="flex flex-col pr-14">
                                <div className="text-blue-100/80 text-xs mb-1 font-medium tracking-wider">
                                    {isSwapMode ? `${currentCurrObj.flag} ${currentCurrObj.name} (${currentCurrObj.code})` : 'ğŸ‡¹ğŸ‡¼ å°å¹£ (TWD)'}
                                </div>
                                <div className={`font-bold text-yellow-300 tracking-tight transition-all ${getDynamicFontSize(displayResult, false)}`}>
                                    {displayResult}
                                </div>
                            </div>

                            {/* åŒ¯ç‡å°å­— */}
                            <div className="absolute bottom-3 right-5 text-[10px] text-white/50 font-light">
                                {rateString}
                            </div>
                        </div>

                        {/* è²¨å¹£é¸æ“‡å™¨ (å·²ä¿®å¾©ï¼š-mx-4 px-4 Full Bleed æ•ˆæœ) */}
                        <div className="-mx-4 px-4 flex overflow-x-auto no-scrollbar gap-2 py-4">
                            {CURRENCIES.map(curr => (
                                <button
                                    key={curr.code}
                                    onClick={() => setTargetCurrency(curr.code)}
                                    className={`flex flex-col items-center justify-center min-w-[3.6rem] h-[3.6rem] rounded-xl transition-all active-scale border flex-shrink-0 ${
                                        targetCurrency === curr.code 
                                        ? 'bg-white text-blue-900 border-white shadow-lg scale-105 font-bold' 
                                        : 'bg-white/10 text-white/80 border-transparent hover:bg-white/20'
                                    }`}
                                >
                                    <span className="text-lg leading-none mb-1 filter-none">{curr.flag}</span>
                                    <span className="text-[10px]">{curr.code}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* ä¸‹åŠéƒ¨ï¼šç™½è‰²éµç›¤å€ (å›ºå®šé«˜åº¦èˆ‡ä½ˆå±€) */}
                    <div className="bg-white rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.15)] z-20 px-5 pt-3 pb-safe-bottom w-full">
                        
                        {/* éµç›¤ä¸Šæ–¹å·¥å…·åˆ— (ä¾†æº + æ¸…é™¤) */}
                        <div className="flex justify-between items-center mb-3 px-1">
                            <div className="text-[10px] text-gray-400">
                                Developer: Angus â€¢ Source: ExchangeRate-API
                            </div>
                            <button 
                                onClick={handleClear}
                                className="text-red-500 font-bold text-sm px-4 py-1.5 bg-red-50 rounded-full active:bg-red-100 transition-colors flex items-center gap-1"
                            >
                                <i className="fa-solid fa-eraser"></i> æ¸…é™¤
                            </button>
                        </div>

                        {/* æ•¸å­—éµç›¤ Grid (3æ¬„ x 4åˆ—) */}
                        <div className="grid grid-cols-3 gap-3 pb-6">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                                <button
                                    key={num}
                                    onClick={() => handleNumClick(num.toString())}
                                    className="key-btn"
                                >
                                    {num}
                                </button>
                            ))}
                            
                            <button onClick={() => handleNumClick('.')} className="key-btn text-2xl pb-2">.</button>
                            <button onClick={() => handleNumClick('0')} className="key-btn">0</button>
                            <button onClick={handleBackspace} className="key-btn text-gray-500"><i className="fa-solid fa-delete-left"></i></button>
                        </div>
                    </div>

                    {/* PWA å®‰è£æç¤º Banner */}
                    {showInstallPrompt && (
                        <div className="fixed bottom-0 left-0 w-full z-50 p-4 install-banner pb-safe-bottom">
                            <div className="bg-gray-900/95 backdrop-blur text-white rounded-2xl p-4 shadow-2xl border border-gray-700 max-w-md mx-auto relative">
                                <button onClick={closeInstallPrompt} className="absolute top-2 right-2 text-gray-400 hover:text-white w-6 h-6 flex items-center justify-center">
                                    <i className="fa-solid fa-xmark"></i>
                                </button>
                                
                                <div className="flex gap-4 items-center">
                                    <div className="bg-blue-600 w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 text-xl shadow-lg">
                                        <i className="fa-solid fa-coins"></i>
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="font-bold text-sm">å®‰è£åˆ°ä¸»ç•«é¢</h3>
                                        <p className="text-xs text-gray-400 mt-1">
                                            {isIOS 
                                                ? "é»æ“Šä¸‹æ–¹åˆ†äº«æŒ‰éˆ•ï¼Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€å³å¯é›¢ç·šä½¿ç”¨ã€‚" 
                                                : "é»æ“Šå®‰è£æŒ‰éˆ•ï¼Œäº«å—æ›´æµæš¢çš„é«”é©—ã€‚"}
                                        </p>
                                    </div>
                                </div>

                                {!isIOS && (
                                    <button onClick={handleInstallClick} className="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-xl text-sm transition-colors">
                                        å®‰è£ App
                                    </button>
                                )}
                                
                                {isIOS && (
                                    <div className="mt-3 flex items-center justify-center gap-2 text-xs text-blue-300 font-medium bg-blue-900/30 py-2 rounded-lg border border-blue-500/30">
                                        <span>Safari: é»æ“Š</span>
                                        <i className="fa-solid fa-arrow-up-from-bracket text-base"></i>
                                        <span>åˆ†äº« â†’ åŠ å…¥ä¸»ç•«é¢</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
